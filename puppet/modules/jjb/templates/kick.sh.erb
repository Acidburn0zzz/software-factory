#!/bin/bash

set -x
if [ -f /root/config.kicked ]; then
    echo "Already kicked..."
#    exit 1
fi

# temp check just to be sure...
service apache2 reload || true
service httpd reload || true

RETRIES=0
while true; do
    wget --spider --user=<%= @settings['jenkins_username'] %> --password=<%= @settings['jenkins_password'] %> http://localhost:8080/jenkins/
    [ $? -eq 0 ] && break
    let RETRIES=RETRIES+1
    [ "$RETRIES" == "120" ] && {
        echo "Jenkins took too long to be up !"
        exit 1
    }
    sleep 1
done

if [ ! -d "/root/config" ]; then
    git clone http://<%= scope.function_hiera(["gerrit_url"]) %>/r/config /root/config
fi

# JJB
RETRIES=0
while true; do
    jenkins-jobs update /root/config/jobs
    [ $? -eq 0 ] && break
    let RETRIES=RETRIES+1
    [ "$RETRIES" == "30" ] && {
        echo "Unable to update jenkins job (jjb) !"
        exit 1
    }
    sleep 1
done

# Jenkins jobs are not updated by gearman plugin
# TODO: Find a way to just restart the gearman plugin
service jenkins restart 

# Zuul
cp /root/config/zuul/layout.yaml /etc/zuul/
service zuul reload
touch /root/config.kicked
