heat_template_version: 2013-05-23

description: >
  Heat SoftwareFactory template.

parameters:
  key_name:
    type: string
    description:  Name of a KeyPair to enable SSH access to the instance
  suffix:
    type: string
    description: Domain suffix to the hostnames
    default: sf.dom
  jenkins_user_pwd:
    type: string
    description: jenkins user password, jenkins slave has to provide this password to connect to master
    default: userpass
  jenkins_master_url:
    type: string
    description: url/hostname(without http://) of jenkins master node to which slave connects
  sf_config_content:
    type: string
    description: Base64 yaml configuration file for SoftwareFactory
  temp_ssh_pwd:
    type: string
    description: Used temporary to trigger puppet agents on each node
    default: heat
  instance_type:
    type: string
    description: Instance type for sf roles (ldap, commonservices, managesf)
  alt_instance_type:
    type: string
    description: Instance type for sf roles (mysql, gerrit, jenkins, redmine, puppetmaster)
  puppetmaster_image_id:
    type: string
    description: Glance image ID for the puppet master node
  ldap_image_id:
    type: string
    description: Glance image ID for the ldap node
  mysql_image_id:
    type: string
    description: Glance image ID for the mysql node
  slave_image_id:
    type: string
    description: Glance image ID for the slave node
  sf_image_id:
    type: string
    description: Glance image ID for all the other sf nodes
  ext_net_uuid:
    type: string
    description: The UUID of the external net
  sg_admin_cidr:
    type: string
    description: From Ip range to access node by ssh
    default: 0.0.0.0/0
  sg_user_cidr:
    type: string
    description: From Ip range to access user services of SF
    default: 0.0.0.0/0

resources:
  sf_net:
    type: OS::Neutron::Net
    properties:
      name: SF_Net

  sf_subnet:
    type: OS::Neutron::Subnet
    properties:
      network_id: { get_resource: sf_net }
      cidr: 192.168.0.0/24
      enable_dhcp: true

  router:
    type: OS::Neutron::Router

  router_gateway:
    type: OS::Neutron::RouterGateway
    properties:
      router_id: { get_resource: router }
      network_id: { get_param: ext_net_uuid }

  router_interface:
    type: OS::Neutron::RouterInterface
    properties:
      router_id: { get_resource: router }
      subnet_id: { get_resource: sf_subnet }

  sf_ext_secgroup_admin:
    type: OS::Neutron::SecurityGroup
    properties:
      rules: [
        {remote_ip_prefix: { get_param: sg_admin_cidr },
         protocol: tcp,
         port_range_min: 22,
         port_range_max: 22,},
        {remote_ip_prefix: { get_param: sg_admin_cidr },
         protocol: icmp,}
        ]
  
  sf_ext_secgroup_http:
    type: OS::Neutron::SecurityGroup
    properties:
      rules: [
        {remote_ip_prefix: { get_param: sg_user_cidr },
         protocol: tcp,
         port_range_min: 80,
         port_range_max: 80},
        ]
  
  sf_ext_secgroup_alt_http:
    type: OS::Neutron::SecurityGroup
    properties:
      rules: [
        {remote_ip_prefix: { get_param: sg_user_cidr },
         protocol: tcp,
         port_range_min: 8080,
         port_range_max: 8080},
        ]
  
  sf_ext_secgroup_gerrit_ssh:
    type: OS::Neutron::SecurityGroup
    properties:
      rules: [
        {remote_ip_prefix: { get_param: sg_user_cidr },
         protocol: tcp,
         port_range_min: 29418,
         port_range_max: 29418},
        ]
  
  sf_int_secgroup_default:
    type: OS::Neutron::SecurityGroup
    properties:
      rules: [
        {remote_ip_prefix: 192.168.0.0/24,
         protocol: tcp,
         port_range_min: 1,
         port_range_max: 65535},
        {remote_ip_prefix: 192.168.0.0/24,
         protocol: icmp,}
        ]

  jenkins_neutron_port:
    type: OS::Neutron::Port
    properties:
      network: { get_resource: sf_net }
      security_groups: [ { get_resource: sf_ext_secgroup_admin },
                         { get_resource: sf_ext_secgroup_http },
                         { get_resource: sf_ext_secgroup_alt_http },
                         { get_resource: sf_int_secgroup_default },
                         ]

  redmine_neutron_port:
    type: OS::Neutron::Port
    properties:
      network: { get_resource: sf_net }
      security_groups: [ { get_resource: sf_ext_secgroup_admin },
                         { get_resource: sf_ext_secgroup_http },
                         { get_resource: sf_int_secgroup_default },
                         ]

  gerrit_neutron_port:
    type: OS::Neutron::Port
    properties:
      network: { get_resource: sf_net }
      security_groups: [ { get_resource: sf_ext_secgroup_admin },
                         { get_resource: sf_ext_secgroup_http },
                         { get_resource: sf_ext_secgroup_gerrit_ssh },
                         { get_resource: sf_int_secgroup_default },
                         ]
  
  gerrit_floating_ip:
    type: OS::Neutron::FloatingIP
    properties:
      port_id: { get_resource: gerrit_neutron_port }
      floating_network_id: { get_param: ext_net_uuid }

  managesf_neutron_port:
    type: OS::Neutron::Port
    properties:
      network: { get_resource: sf_net }
      security_groups: [ { get_resource: sf_ext_secgroup_admin },
                         { get_resource: sf_ext_secgroup_http },
                         { get_resource: sf_ext_secgroup_alt_http },
                         { get_resource: sf_int_secgroup_default },
                         ]

  puppetmaster_neutron_port:
    type: OS::Neutron::Port
    properties:
      network: { get_resource: sf_net }
      security_groups: [ { get_resource: sf_ext_secgroup_admin },
                         { get_resource: sf_int_secgroup_default },
                        ]
  
  puppetmaster_floating_ip:
    type: OS::Neutron::FloatingIP
    properties:
      port_id: { get_resource: puppetmaster_neutron_port }
      floating_network_id: { get_param: ext_net_uuid }

  commonservices_neutron_port:
    type: OS::Neutron::Port
    properties:
      network: { get_resource: sf_net }
      security_groups: [ { get_resource: sf_ext_secgroup_admin },
                         { get_resource: sf_ext_secgroup_http },
                         { get_resource: sf_ext_secgroup_alt_http },
                         { get_resource: sf_int_secgroup_default },
                         ]

  commonservices_floating_ip:
    type: OS::Neutron::FloatingIP
    properties:
      port_id: { get_resource: commonservices_neutron_port }
      floating_network_id: { get_param: ext_net_uuid }

  slave_neutron_port:
    type: OS::Neutron::Port
    properties:
      network: { get_resource: sf_net }
      security_groups: [ { get_resource: sf_int_secgroup_default },
                         ]

  mysql_neutron_port:
    type: OS::Neutron::Port
    properties:
      network: { get_resource: sf_net }
      security_groups: [ { get_resource: sf_int_secgroup_default },
                         ]

  ldap_neutron_port:
    type: OS::Neutron::Port
    properties:
      network: { get_resource: sf_net }
      security_groups: [ { get_resource: sf_int_secgroup_default },
                         ]

  puppetmaster_instance:
    type: OS::Nova::Server
    depends_on: [ commonservices_instance, managesf_instance, gerrit_instance, jenkins_instance, redmine_instance, ldap_instance, mysql_instance, slave_instance ]
    properties:
      image: { get_param: puppetmaster_image_id }
      flavor: { get_param: alt_instance_type }
      key_name: { get_param: key_name }
      networks:
        - port: { get_resource: puppetmaster_neutron_port }
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
            #cloud-config
            output: {all: '| tee -a /var/log/cloud-init-output.log'}
            hostname: puppetmaster
            fqdn: puppetmaster.SF_SUFFIX
            disable_root: 0
            write_files:
            - content: |
                hosts:
                  localhost:
                    ip: 127.0.0.1
                  puppetmaster.SF_SUFFIX:
                    ip: puppermaster-ip-template
                    host_aliases: [puppetmaster]
                  ldap.SF_SUFFIX:
                    ip: ldap_host
                    host_aliases: [ldap]
                  mysql.SF_SUFFIX:
                    ip: mysql_host
                    host_aliases: [mysql]
                  jenkins.SF_SUFFIX:
                    ip: jenkins_host
                    host_aliases: [jenkins]
                  redmine.SF_SUFFIX:
                    ip: redmine_host
                    host_aliases: [redmine]
                  api-redmine.SF_SUFFIX:
                    ip: redmine_host
                  gerrit.SF_SUFFIX:
                    ip: gerrit_host
                    host_aliases: [gerrit]
                  managesf.SF_SUFFIX:
                    ip: managesf_host
                    host_aliases: [managesf, auth.SF_SUFFIX]
                  commonservices.SF_SUFFIX:
                    ip: commonservices_host
                    host_aliases: [commonservices, SF_SUFFIX]
              path: /root/hosts.yaml
            - encoding: b64
              content: SFCONFIGCONTENT
              path: /root/sfconfig.yaml
            runcmd:
              - /etc/init.d/puppetmaster stop
              - MY_PRIV_IP=`curl -s http://169.254.169.254/latest/meta-data/local-ipv4 | cut -d, -f1`
              - sed -i "s/puppermaster-ip-template/$MY_PRIV_IP/" /root/hosts.yaml
              - echo "127.0.0.1 puppetmaster.SF_SUFFIX puppetmaster" > /etc/hosts
              - echo "ldap_host ldap.SF_SUFFIX ldap" >> /etc/hosts
              - echo "mysql_host mysql.SF_SUFFIX mysql" >> /etc/hosts
              - echo "jenkins_host jenkins.SF_SUFFIX jenkins" >> /etc/hosts
              - echo "redmine_host redmine.SF_SUFFIX redmine" >> /etc/hosts
              - echo "gerrit_host gerrit.SF_SUFFIX gerrit" >> /etc/hosts
              - echo "managesf_host managesf.SF_SUFFIX auth.SF_SUFFIX managesf" >> /etc/hosts
              - echo "commonservices_host commonservices.SF_SUFFIX commonservices SF_SUFFIX" >> /etc/hosts
              - tar -xzf /root/puppet-bootstrapper.tar.gz -C /root/
              - cd /root/puppet-bootstrapper
              - ./config_puppetmaster.sh > /var/log/sf-bootstrap.log 2>&1
              - HOME=/root/ JUP=JENKINS_USER_PASSWORD TEMP_SSH_PWD=SSHPASS SFSUFFIX=SF_SUFFIX ./bootstrap.sh >> /var/log/sf-bootstrap.log 2>&1
          params:
            jenkins_host: { get_attr: [jenkins_instance, first_address] }
            redmine_host: { get_attr: [redmine_instance, first_address] }
            gerrit_host: { get_attr: [gerrit_instance, first_address] }
            managesf_host: { get_attr: [managesf_instance, first_address] }
            commonservices_host: { get_attr: [commonservices_instance, first_address] }
            ldap_host: { get_attr: [ldap_instance, first_address] }
            mysql_host: { get_attr: [mysql_instance, first_address] }
            SF_SUFFIX: { get_param: suffix }
            SFCONFIGCONTENT: { get_param: sf_config_content }
            SSHPASS: { get_param: temp_ssh_pwd }
            JENKINS_USER_PASSWORD: { get_param: jenkins_user_pwd }

  jenkins_instance:
    type: OS::Nova::Server
    properties:
      image: { get_param: sf_image_id }
      flavor: { get_param: alt_instance_type }
      key_name: { get_param: key_name }
      networks:
        - port: { get_resource: jenkins_neutron_port }
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
            #cloud-config
            output: {all: '| tee -a /var/log/cloud-init-output.log'}
            hostname: jenkins
            fqdn: jenkins.SF_SUFFIX
            disable_root: 0
            runcmd:
              - /etc/init.d/puppet stop
              - echo puppetmaster-ip-template puppetmaster.SF_SUFFIX >> /etc/hosts
              - sed -i -e '0,/^$/s/^$/server=puppetmaster.SF_SUFFIX\n/g' /etc/puppet/puppet.conf
              - /bin/echo -e "\n[agent]\nenvironment=sf" >> /etc/puppet/puppet.conf
              - echo "root:SSHPASS" | chpasswd
          params:
            SF_SUFFIX: { get_param: suffix }
            SSHPASS: { get_param: temp_ssh_pwd }
  
  redmine_instance:
    type: OS::Nova::Server
    properties:
      image: { get_param: sf_image_id }
      flavor: { get_param: alt_instance_type }
      key_name: { get_param: key_name }
      networks:
        - port: { get_resource: redmine_neutron_port }
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
            #cloud-config
            output: {all: '| tee -a /var/log/cloud-init-output.log'}
            hostname: redmine
            fqdn: redmine.SF_SUFFIX
            disable_root: 0
            runcmd:
              - /etc/init.d/puppet stop
              - echo puppetmaster-ip-template puppetmaster.SF_SUFFIX >> /etc/hosts
              - sed -i -e '0,/^$/s/^$/server=puppetmaster.SF_SUFFIX\n/g' /etc/puppet/puppet.conf
              - /bin/echo -e "\n[agent]\nenvironment=sf" >> /etc/puppet/puppet.conf
              - echo "root:SSHPASS" | chpasswd
          params:
            SF_SUFFIX: { get_param: suffix }
            SSHPASS: { get_param: temp_ssh_pwd }
  
  gerrit_instance:
    type: OS::Nova::Server
    properties:
      image: { get_param: sf_image_id }
      flavor: { get_param: alt_instance_type }
      key_name: { get_param: key_name }
      networks:
        - port: { get_resource: gerrit_neutron_port }
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
            #cloud-config
            output: {all: '| tee -a /var/log/cloud-init-output.log'}
            hostname: gerrit
            fqdn: gerrit.SF_SUFFIX
            disable_root: 0
            runcmd:
              - /etc/init.d/puppet stop
              - echo puppetmaster-ip-template puppetmaster.SF_SUFFIX >> /etc/hosts
              - sed -i -e '0,/^$/s/^$/server=puppetmaster.SF_SUFFIX\n/g' /etc/puppet/puppet.conf
              - /bin/echo -e "\n[agent]\nenvironment=sf" >> /etc/puppet/puppet.conf
              - echo "root:SSHPASS" | chpasswd
          params:
            SF_SUFFIX: { get_param: suffix }
            SSHPASS: { get_param: temp_ssh_pwd }
  
  commonservices_instance:
    type: OS::Nova::Server
    properties:
      image: { get_param: sf_image_id }
      flavor: { get_param: instance_type }
      key_name: { get_param: key_name }
      networks:
        - port: { get_resource: commonservices_neutron_port }
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
            #cloud-config
            output: {all: '| tee -a /var/log/cloud-init-output.log'}
            hostname: commonservices
            fqdn: commonservices.SF_SUFFIX
            disable_root: 0
            runcmd:
              - /etc/init.d/puppet stop
              - echo puppetmaster-ip-template puppetmaster.SF_SUFFIX >> /etc/hosts
              - sed -i -e '0,/^$/s/^$/server=puppetmaster.SF_SUFFIX\n/g' /etc/puppet/puppet.conf
              - /bin/echo -e "\n[agent]\nenvironment=sf" >> /etc/puppet/puppet.conf
              - echo "root:SSHPASS" | chpasswd
          params:
            SF_SUFFIX: { get_param: suffix }
            SSHPASS: { get_param: temp_ssh_pwd }
  
  managesf_instance:
    type: OS::Nova::Server
    properties:
      image: { get_param: sf_image_id }
      flavor: { get_param: alt_instance_type }
      key_name: { get_param: key_name }
      networks:
        - port: { get_resource: managesf_neutron_port }
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
            #cloud-config
            output: {all: '| tee -a /var/log/cloud-init-output.log'}
            hostname: managesf
            fqdn: managesf.SF_SUFFIX
            disable_root: 0
            runcmd:
              - /etc/init.d/puppet stop
              - echo puppetmaster-ip-template puppetmaster.SF_SUFFIX >> /etc/hosts
              - sed -i -e '0,/^$/s/^$/server=puppetmaster.SF_SUFFIX\n/g' /etc/puppet/puppet.conf
              - /bin/echo -e "\n[agent]\nenvironment=sf" >> /etc/puppet/puppet.conf
              - echo "root:SSHPASS" | chpasswd
          params:
            SF_SUFFIX: { get_param: suffix }
            SSHPASS: { get_param: temp_ssh_pwd }
  
  ldap_instance:
    type: OS::Nova::Server
    properties:
      image: { get_param: ldap_image_id }
      flavor: { get_param: instance_type }
      key_name: { get_param: key_name }
      networks:
        - port: { get_resource: ldap_neutron_port }
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
            #cloud-config
            output: {all: '| tee -a /var/log/cloud-init-output.log'}
            hostname: ldap
            fqdn: ldap.SF_SUFFIX
            disable_root: 0
            write_files:
            - content: |
                dn: olcDatabase={-1}frontend,cn=config
                add: olcRequires
                olcRequires: authc
              path: /root/disable_anon_frontend.ldif
            - content: |
                dn: olcDatabase={1}hdb,cn=config
                add: olcRequires
                olcRequires: authc
              path: /root/disable_anon_backend.ldif
            - content: |
                dn: ou=Users,dc=example,dc=com
                objectClass: organizationalUnit
                ou: Users
              path: /root/users_ou.ldif
            - content: |
                dn: cn=user1,ou=Users,dc=example,dc=com
                cn: user1
                objectClass: person
                sn: Demo user1
                userPassword: userpass
                mail: user1@example.com
                objectClass: inetOrgPerson

                dn: cn=user2,ou=Users,dc=example,dc=com
                cn: user2
                objectClass: person
                sn: Demo user2
                userPassword: userpass
                mail: user2@example.com
                objectClass: inetOrgPerson

                dn: cn=user3,ou=Users,dc=example,dc=com
                cn: user3
                objectClass: person
                sn: Demo user3
                userPassword: userpass
                mail: user3@example.com
                objectClass: inetOrgPerson

                dn: cn=user4,ou=Users,dc=example,dc=com
                cn: user4
                objectClass: person
                sn: Demo user4
                userPassword: userpass
                mail: user4@example.com
                objectClass: inetOrgPerson

                dn: cn=jenkins,ou=Users,dc=example,dc=com
                cn: jenkins
                objectClass: person
                sn: Jenkins
                userPassword: JENKINS_USER_PASSWORD
                mail: jenkins@example.com
                objectClass: inetOrgPerson
              path: /root/demo_users.ldif
            - content: |
                dn: ou=Groups,dc=example,dc=com
                objectClass: organizationalUnit
                ou: Groups
              path: /root/groups_ou.ldif
            - content: |
                dn: cn=group01,ou=Groups,dc=example,dc=com
                cn: group01
                objectClass: organizationalRole
                roleOccupant: cn=user1,dc=example,dc=com
                roleOccupant: cn=user2,dc=example,dc=com

                dn: cn=group02,ou=Groups,dc=example,dc=com
                cn: group02
                objectClass: organizationalRole
                roleOccupant: cn=user1,dc=example,dc=com
                roleOccupant: cn=user3,dc=example,dc=com
              path: /root/groups.ldif
            runcmd:
              - /etc/init.d/puppet stop
              - ldapadd -x -D cn=admin,dc=example,dc=com -w secret -f /root/users_ou.ldif
              - ldapadd -x -D cn=admin,dc=example,dc=com -w secret -f /root/demo_users.ldif
              - ldapadd -x -D cn=admin,dc=example,dc=com -w secret -f /root/groups_ou.ldif
              - ldapadd -x -D cn=admin,dc=example,dc=com -w secret -f /root/groups.ldif
              - ldapmodify -Q -Y EXTERNAL -H ldapi:/// -f /root/disable_anon_frontend.ldif
              - ldapmodify -Q -Y EXTERNAL -H ldapi:/// -f /root/disable_anon_backend.ldif
              - echo puppetmaster-ip-template puppetmaster.SF_SUFFIX >> /etc/hosts
              - sed -i -e '0,/^$/s/^$/server=puppetmaster.SF_SUFFIX\n/g' /etc/puppet/puppet.conf
              - /bin/echo -e "\n[agent]\nenvironment=sf" >> /etc/puppet/puppet.conf
              - echo "root:SSHPASS" | chpasswd
          params:
            SF_SUFFIX: { get_param: suffix }
            SSHPASS: { get_param: temp_ssh_pwd }
            JENKINS_USER_PASSWORD: { get_param: jenkins_user_pwd }
  
  mysql_instance:
    type: OS::Nova::Server
    properties:
      image: { get_param: mysql_image_id }
      flavor: { get_param: alt_instance_type }
      key_name: { get_param: key_name }
      networks:
        - port: { get_resource: mysql_neutron_port }
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
            #cloud-config
            output: {all: '| tee -a /var/log/cloud-init-output.log'}
            hostname: mysql
            fqdn: mysql.SF_SUFFIX
            disable_root: 0
            runcmd:
              - /etc/init.d/puppet stop
              - echo puppetmaster-ip-template puppetmaster.SF_SUFFIX >> /etc/hosts
              - sed -i -e '0,/^$/s/^$/server=puppetmaster.SF_SUFFIX\n/g' /etc/puppet/puppet.conf
              - /bin/echo -e "\n[agent]\nenvironment=sf" >> /etc/puppet/puppet.conf
              - echo "root:SSHPASS" | chpasswd
          params:
            SF_SUFFIX: { get_param: suffix }
            SSHPASS: { get_param: temp_ssh_pwd }
  
  slave_instance:
    type: OS::Nova::Server
    properties:
      image: { get_param: slave_image_id }
      flavor: { get_param: instance_type }
      key_name: { get_param: key_name }
      networks:
        - port: { get_resource: slave_neutron_port }
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
            #cloud-config
            output: {all: '| tee -a /var/log/cloud-init-output.log'}
            hostname: slave
            fqdn: slave.SF_SUFFIX
            manage_etc_hosts: true
            disable_root: 0
            groups:
              - jenkins: [jenkins]
            users:
              - name: jenkins
                primary-group: jenkins
                lock-passwd: false
                plain_text_passwd: JENKINS_USER_PASSWORD
                homedir: /var/lib/jenkins
            write_files:
            - content: |
                127.0.1.1 $fqdn $hostname
                JENKINS_IP jenkins.SF_SUFFIX jenkins
              path: /etc/cloud/templates/hosts.tmpl
            runcmd:
             - chown jenkins /var/lib/jenkins /var/lib/jenkins/plugins
             - echo "JENKINS_IP jenkins.SF_SUFFIX jenkins" >> /etc/hosts
             - nohup sudo -u jenkins -i java -jar /var/lib/jenkins/swarm-client-1.15-jar-with-dependencies.jar -master http://JENKINS_MASTER_URL:8080 -username jenkins -password JENKINS_USER_PASSWORD -name slave.SF_SUFFIX > /dev/null 2>&1 & echo $!
          params:
            SF_SUFFIX: { get_param: suffix }
            JENKINS_MASTER_URL: { get_param: jenkins_master_url }
            JENKINS_USER_PASSWORD: { get_param: jenkins_user_pwd }
            JENKINS_IP: { get_attr: [jenkins_instance, first_address] }


outputs:
  commonservices_public_address:
    description: Public address of Commonservices
    value:
      str_replace:
        template: "Public address of the commonservices instance: host"
        params:
          host: { get_attr: [commonservices_floating_ip, floating_ip_address] }
  gerrit_public_address:
    description: Public address of Gerrit
    value:
      str_replace:
        template: "Public address of the Gerrit instance: host"
        params:
          host: { get_attr: [gerrit_floating_ip, floating_ip_address] }
  puppetmaster_public_address:
    description: Public address of Puppetmaster
    value:
      str_replace:
        template: "Public address of the Puppetmaster instance: host"
        params:
          host: { get_attr: [puppetmaster_floating_ip, floating_ip_address] }

